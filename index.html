<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŠ˜ë°¤ì˜ ì—°ëŒ€ê¸° : ë³„ë¹› ì•„ë˜ì˜ ì„œì•½ (ì™„ê²°íŒ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0a0a1a;
      --panel: rgba(20, 20, 40, 0.85);
      --accent: #647cff;
      --accent-2: #9aa7ff;
      --text: #f0f0f0;
      --muted: #cfd3ff;
      --danger: #ff6b6b;
      --shadow: 0 0 24px rgba(0,0,0,0.6);
    }
    * { box-sizing: border-box; }
    body {
      background: radial-gradient(1200px 800px at 15% 10%, rgba(255,255,255,0.06), transparent 50%),
                  radial-gradient(900px 700px at 85% 20%, rgba(255,255,255,0.05), transparent 50%),
                  var(--bg);
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 24px;
    }
    #game {
      width: min(960px, 100%);
      background: var(--panel);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-rows: auto auto 320px auto auto;
      gap: 16px;
    }
    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }
    h1 {
      font-size: clamp(18px, 3vw, 24px);
      margin: 0;
      letter-spacing: 0.5px;
    }
    #episode {
      font-size: 14px;
      color: var(--muted);
    }
    #character {
      height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      outline: 1px solid rgba(255,255,255,0.08);
    }
    #character img {
      max-height: 100%;
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(255,255,255,0.2);
      opacity: 0;
      transform: scale(1.02);
      transition: opacity .45s ease, transform .6s ease;
    }
    #character img.show {
      opacity: 1;
      transform: scale(1);
    }
    #dialogue {
      position: relative;
      min-height: 120px;
      font-size: 18px;
      line-height: 1.65;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 16px 18px;
      outline: 1px solid rgba(255,255,255,0.06);
    }
    #choices {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .choice-btn, .tool-btn {
      background: linear-gradient(180deg, var(--accent), #465dff);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
      box-shadow: 0 4px 10px rgba(100,124,255,0.25);
      font-size: 16px;
    }
    .choice-btn:hover, .tool-btn:hover { filter: brightness(1.05); }
    .choice-btn:active, .tool-btn:active { transform: translateY(1px); }
    #toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    #statusPanel {
      display: none;
      border-top: 1px dashed rgba(255,255,255,0.12);
      padding-top: 10px;
      font-size: 14px;
    }
    .meter {
      display: grid;
      grid-template-columns: 92px 1fr 42px;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    .meter .bar {
      height: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      outline: 1px solid rgba(255,255,255,0.06);
    }
    .meter .fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-2), var(--accent));
      transition: width .3s ease;
    }
    .muted { color: var(--muted); }
    .danger { color: var(--danger); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    #footnote {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      opacity: .9;
    }
    @media (min-width: 720px) {
      #choices {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="game">
    <header>
      <div>
        <h1>ëŠ˜ë°¤ì˜ ì—°ëŒ€ê¸° : ë³„ë¹› ì•„ë˜ì˜ ì„œì•½</h1>
        <div id="episode" class="muted">Episode 1</div>
      </div>
      <div id="toolbar">
        <button id="saveBtn" class="tool-btn">ì €ì¥</button>
        <button id="loadBtn" class="tool-btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="statusBtn" class="tool-btn">ìƒíƒœ</button>
        <button id="restartBtn" class="tool-btn">ì²˜ìŒë¶€í„°</button>
      </div>
    </header>

    <div id="character"></div>
    <div id="dialogue"></div>
    <div id="choices"></div>

    <div id="statusPanel">
      <div class="meter"><div>ì—˜ë¦¬ì‹œì•„</div><div class="bar"><div id="elysiaBar" class="fill"></div></div><div id="elysiaVal" class="mono">0</div></div>
      <div class="meter"><div>ë£¨ë‚˜</div><div class="bar"><div id="lunaBar" class="fill"></div></div><div id="lunaVal" class="mono">0</div></div>
      <div class="meter"><div>ì„¸ë¼í”¼ì•„</div><div class="bar"><div id="seraphiaBar" class="fill"></div></div><div id="seraphiaVal" class="mono">0</div></div>
      <div class="muted">ë£¨íŠ¸: <span id="routeVal">ë¯¸ì •</span> Â· ê¹ƒë°œ: <span id="flagsVal" class="mono">{} </span></div>
    </div>

    <div id="footnote">Â© ë³„ë¹› ì•„ë˜ì˜ ì„œì•½ â€” HTML/JS ë¯¸ë‹ˆ VN ì—”ì§„ (ì„¸ì´ë¸Œ/ë¡œë“œ ì§€ì›)</div>
  </div>

  <script>
    // ---------- Core Nodes ----------
    const dialogueBox = document.getElementById("dialogue");
    const choicesBox = document.getElementById("choices");
    const characterBox = document.getElementById("character");
    const episodeEl = document.getElementById("episode");
    const statusPanel = document.getElementById("statusPanel");
    const elysiaBar = document.getElementById("elysiaBar");
    const lunaBar = document.getElementById("lunaBar");
    const seraphiaBar = document.getElementById("seraphiaBar");
    const elysiaVal = document.getElementById("elysiaVal");
    const lunaVal = document.getElementById("lunaVal");
    const seraphiaVal = document.getElementById("seraphiaVal");
    const routeVal = document.getElementById("routeVal");
    const flagsVal = document.getElementById("flagsVal");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const statusBtn = document.getElementById("statusBtn");
    const restartBtn = document.getElementById("restartBtn");

    // ---------- State ----------
    let state = {
      affection: { elysia: 0, luna: 0, seraphia: 0 },
      flags: {},              // ì„ì˜ì˜ í”Œë˜ê·¸ ì €ì¥ (ì˜ˆ: ê³„ì•½ìˆ˜ë½, ë„ì„œê´€ê¸°ë¡, ì„œì•½ìˆ˜í–‰ ë“±)
      route: null,            // 'elysia' | 'luna' | 'solo'
      scene: "E1_intro",
      episode: 1,
      typewriter: true
    };

    function resetState() {
      state = {
        affection: { elysia: 0, luna: 0, seraphia: 0 },
        flags: {},
        route: null,
        scene: "E1_intro",
        episode: 1,
        typewriter: true
      };
      showScene(state.scene);
    }

    // ---------- Utils ----------
  // ---------- Utils ----------
  function setImage(key) {
      characterBox.innerHTML = "";
      if (!key) return;

      // ë¹„ë””ì˜¤ í™•ì¥ìì¸ì§€ í™•ì¸
      const isVideo = key.endsWith(".mp4") || key.endsWith(".webm");

      if (isVideo) {
        const vid = document.createElement("video");
        vid.src = `videos/${key}`;
        vid.autoplay = true;
        vid.loop = true;
        vid.muted = true;
        vid.playsInline = true;
        vid.style.maxWidth = "100%";
        vid.style.maxHeight = "100%";
        vid.style.borderRadius = "12px";
        characterBox.appendChild(vid);
      } else {
        const img = document.createElement("img");
        img.src = `images/${key}.png`;
        img.alt = key;
        characterBox.appendChild(img);
        requestAnimationFrame(() => img.classList.add("show"));
      }
    }


    function setEpisode(num) {
      episodeEl.textContent = `Episode ${num}`;
    }

    function typeText(text) {
      // ê°„ë‹¨ íƒ€ì´í•‘ íš¨ê³¼
      if (!state.typewriter) {
        dialogueBox.textContent = text;
        return;
      }
      dialogueBox.textContent = "";
      let i = 0;
      const speed = 15 + Math.random() * 10;
      function step() {
        dialogueBox.textContent = text.slice(0, i);
        i++;
        if (i <= text.length) {
          setTimeout(step, speed);
        }
      }
      step();
    }

    function updateStatus() {
      const e = Math.max(0, Math.min(100, state.affection.elysia * 10));
      const l = Math.max(0, Math.min(100, state.affection.luna * 10));
      const s = Math.max(0, Math.min(100, state.affection.seraphia * 10));
      elysiaBar.style.width = e + "%";
      lunaBar.style.width = l + "%";
      seraphiaBar.style.width = s + "%";
      elysiaVal.textContent = state.affection.elysia;
      lunaVal.textContent = state.affection.luna;
      seraphiaVal.textContent = state.affection.seraphia;
      routeVal.textContent = state.route ? state.route : "ë¯¸ì •";
      flagsVal.textContent = JSON.stringify(state.flags);
    }

    function applyAffection(aff) {
      if (!aff) return;
      for (const k in aff) {
        if (state.affection[k] === undefined) continue;
        state.affection[k] += aff[k];
      }
    }

    function applyFlags(setFlag, unsetFlag) {
      if (setFlag) for (const k in setFlag) state.flags[k] = setFlag[k];
      if (unsetFlag) for (const k in unsetFlag) delete state.flags[k];
    }

    function saveGame() {
      localStorage.setItem("nulbam_full_save", JSON.stringify(state));
      flash("[ì €ì¥ ì™„ë£Œ]");
    }
    function loadGame() {
      const raw = localStorage.getItem("nulbam_full_save");
      if (!raw) return flash("[ì €ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤]");
      try {
        const saved = JSON.parse(raw);
        state = saved;
        showScene(state.scene);
        flash("[ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ]");
      } catch (e) {
        flash("[ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨]");
      }
    }
    function flash(message) {
      const el = document.createElement("div");
      el.textContent = message;
      el.style.position = "fixed";
      el.style.bottom = "20px";
      el.style.left = "50%";
      el.style.transform = "translateX(-50%)";
      el.style.background = "rgba(0,0,0,0.7)";
      el.style.color = "#fff";
      el.style.padding = "8px 12px";
      el.style.borderRadius = "8px";
      el.style.fontSize = "14px";
      el.style.boxShadow = "0 6px 16px rgba(0,0,0,0.3)";
      el.style.zIndex = "9999";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1200);
    }

    saveBtn.onclick = saveGame;
    loadBtn.onclick = loadGame;
    statusBtn.onclick = () => {
      statusPanel.style.display = statusPanel.style.display === "none" ? "block" : "none";
      updateStatus();
    };
    restartBtn.onclick = resetState;

    // ---------- Scene Engine ----------
    // ì¥ë©´ êµ¬ì¡°: { text, image, choices: [{ text, next, affection?, setFlag?, unsetFlag?, setRoute?, goto?: 'ENDING'|'CHECK' }], episode? }
    const scenes = {
      // --------- Episode 1: ë³„ ì—†ëŠ” ì‹ ì…ìƒ ---------
      E1_intro: {
        episode: 1,
        image: "nulbam",
        text:
"ğŸŒŒ ë³„ë¹›ì´ íë¥´ëŠ” ë°¤, ë£¨ë¯¸ë‚˜ìŠ¤ ì•„ì¹´ë°ë¯¸ì˜ ì¢…ì´ ìš¸ë¦°ë‹¤.\nëª¨ë“  ì‹ ì…ìƒì´ â€˜ë³„ì˜ ì¡°ê°â€™ì„ ë“¤ì–´ ë³´ì´ì§€ë§Œ, ë‹¹ì‹ ì˜ ì†ì—ëŠ” ì•„ë¬´ê²ƒë„ ì—†ë‹¤.\n\nì´ë¦„: ëŠ˜ë°¤. ê·¸ëŸ¬ë‚˜ â€” ë‹¹ì‹ ì—ê² â€˜ë³„â€™ì´ ì—†ë‹¤.",
        choices: [{ text: "ê³„ì†...", next: "E1_elysia_meet" }]
      },
      E1_elysia_meet: {
        episode: 1,
        image: "elysia",
        text:
"ì—˜ë¦¬ì‹œì•„: \"ë‹¹ì‹ ì´â€¦ ë³„ ì—†ëŠ” ì‹ ì…ìƒì´êµ°ìš”?\"\nê·¸ë…€ì˜ ëˆˆë¹›ì€ ì–¼ìŒì²˜ëŸ¼ ì°¨ê°‘ì§€ë§Œ, ê·¸ ì†ì— ë¯¸ë¬˜í•œ í˜¸ê¸°ì‹¬ì´ ìŠ¤ì¹œë‹¤.",
        choices: [
          { text: "ê·¸ë˜, ë­ ì–´ë•Œ?", next: "E1_elysia_choice1", affection: { elysia: 1 } },
          { text: "â€¦ê·¸ëŸ°ê°€ìš”?", next: "E1_elysia_choice2", affection: { elysia: 2 } },
          { text: "ì‹ ê²½ êº¼ì¤˜.", next: "E1_elysia_choice3", affection: { elysia: -1 } }
        ]
      },
      E1_elysia_choice1: {
        episode: 1, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ìì‹ ê°ì€ ì¢‹ë„¤ìš”. í•˜ì§€ë§Œ ìë§Œì€ ìœ„í—˜í•˜ë‹µë‹ˆë‹¤.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E1_reflection" }]
      },
      E1_elysia_choice2: {
        episode: 1, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ê´œì•„ìš”. ì²˜ìŒì—” ëˆ„êµ¬ë‚˜ ë‘ë µì£ . ë³„ì˜ ë¹›ì€, ë•Œë¡œ ìŠ¤ìŠ¤ë¡œë¥¼ ìˆ¨ê¸°ê¸°ë„ í•´ìš”.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E1_reflection" }]
      },
      E1_elysia_choice3: {
        episode: 1, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ë¬´ë¡€í•˜êµ°ìš”â€¦ í•˜ì§€ë§Œ, í¥ë¯¸ë¡­ê¸°ë„ í•˜ë„¤ìš”.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E1_reflection" }]
      },
      E1_reflection: {
        episode: 1, image: "nulbam",
        text:
"ğŸ”® ë³„ ì—†ëŠ” ë°¤ì€ ìœ ë‚œíˆ ì¡°ìš©í•˜ë‹¤. ê·¸ëŸ¬ë‚˜ í•˜ëŠ˜ í•œì¼ ì—ì„œ, ê²€ì€ ë¹›ì´ ê¹œë°•ì¸ë‹¤.\nâ€˜ê²€ì€ ë³„â€™ â€” ê·¸ê²ƒì´ ë‚  ë°”ë¼ë³´ê³  ìˆë‹¤.",
        choices: [{ text: "ë‹¤ìŒ ë‚ ì„ ë§ì´í•œë‹¤", next: "E1_end" }]
      },
      E1_end: {
        episode: 1, image: "nulbam",
        text: "ã€1í™” ëã€‘\në‚´ì¼, ì–´ë‘  ì†ì„± ìˆ˜ì—…ì´ ì‹œì‘ëœë‹¤.",
        choices: [{ text: "â–¶ 2í™” ì‹œì‘", next: "E2_intro" }]
      },

      // --------- Episode 2: ì–´ë‘  ì†ì˜ ì†Œë…€ (ë£¨ë‚˜) ---------
      E2_intro: {
        episode: 2, image: "luna",
        text:
"ì–´ë‘  ì†ì„± ì‹¤ìŠµì‹¤. ìƒˆë²½ë³´ë‹¤ ê³ ìš”í•œ ê³³.\në£¨ë‚˜: \"í˜¹ì‹œâ€¦ ë‹¹ì‹ ë„ ë³„ì„ ìƒì—ˆë‚˜ìš”?\"\nê·¸ë…€ì˜ ëª©ì†Œë¦¬ëŠ” ì†ì‚­ì„ì²˜ëŸ¼ ë¶€ë“œëŸ½ë‹¤.",
        choices: [
          { text: "ê³ ê°œë¥¼ ë„ë•ì¸ë‹¤.", next: "E2_luna_bond", affection: { luna: 2 } },
          { text: "ì•„ë‹ˆ, ì•„ì§ ì°¾ëŠ” ì¤‘ì´ì•¼.", next: "E2_luna_bond", affection: { luna: 1 } },
          { text: "ë§ì—†ì´ í”¼í•œë‹¤.", next: "E2_luna_distance", affection: { luna: -1 } }
        ]
      },
      E2_luna_bond: {
        episode: 2, image: "luna",
        text:
"ë£¨ë‚˜: \"ë‚˜ë„ ê·¸ë˜ìš”. ê·¸ë˜ì„œ ë°°ì› ì–´ìš”, ë¹›ì€ ì–´ë‘  ì˜†ì— ìˆì„ ë•Œ ë” ì„ ëª…í•˜ë‹¤ëŠ” ê±¸.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E2_shadow_hint" }]
      },
      E2_luna_distance: {
        episode: 2, image: "luna",
        text:
"ë£¨ë‚˜ëŠ” ì‚´ì§ ë‚´ë ¤ë†“ì€ ì‹œì„ ìœ¼ë¡œ ë‹¹ì‹ ì„ ë– ë³¸ë‹¤.\në£¨ë‚˜: \"ê·¸ëŸ¼â€¦ ì–¸ì  ê°€, ë§í•´ì¤˜ìš”. ë„ˆì˜ ë°¤ì„.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E2_shadow_hint" }]
      },
      E2_shadow_hint: {
        episode: 2, image: "luna",
        text:
"ê²€ì€ ë³„ì˜ ë–¨ë¦¼ì´ ë‹¤ì‹œ ëŠê»´ì§„ë‹¤. ë£¨ë‚˜ëŠ” ì†ì‚­ì¸ë‹¤.\n\"ê¸ˆì§€ëœ ë„ì„œê´€ì—ì„œ, ìƒì–´ë²„ë¦° ë³„ ê¸°ë¡ì„ ë´¤ì–´ìš”.\"",
        choices: [{ text: "ë‹¨ì„œë¥¼ ê¸°ì–µí•´ ë‘”ë‹¤", next: "E2_end", setFlag: { got_hint_library: true } }]
      },
      E2_end: {
        episode: 2, image: "nulbam",
        text: "ã€2í™” ëã€‘\nê¸ˆì§€ëœ ë„ì„œê´€â€¦ ê·¸ê³³ì— ë‹µì´ ìˆì„ê¹Œ?",
        choices: [{ text: "â–¶ 3í™” ì‹œì‘", next: "E3_intro" }]
      },

      // --------- Episode 3: ë³„ì˜ ì”í–¥ (ëŒ€ë¦½ì˜ ì”¨ì•—) ---------
      E3_intro: {
        episode: 3, image: "elysia",
        text:
"ì—˜ë¦¬ì‹œì•„: \"ë£¨ë‚˜ì™€ ê°€ê¹Œì›Œì¡Œêµ°ìš”. ì–´ë‘ ì˜ ì†ì‚­ì„ì€ ë‹¬ì½¤í•˜ì£ . ê·¸ëŸ¬ë‚˜ ë¹›ì€ ë‹¨ë‹¨í•¨ì—ì„œ ë¹„ë¡¯ë©ë‹ˆë‹¤.\"\në‘ ì‚¬ëŒ ì‚¬ì´ì— ë³´ì´ì§€ ì•ŠëŠ” ê¸´ì¥ì´ ìƒê²¨ë‚œë‹¤.",
        choices: [
          { text: "ì—˜ë¦¬ì‹œì•„ì˜ ì—„ì •í•¨ì„ ì§€ì§€í•œë‹¤", next: "E3_side_elysia", affection: { elysia: 2 } },
          { text: "ë£¨ë‚˜ì˜ ê³µê°ì— ê¸°ëŒ€ì„ ë‹¤", next: "E3_side_luna", affection: { luna: 2 } },
          { text: "ë‚˜ëŠ” ë‚´ ê¸¸ì„ ê°„ë‹¤", next: "E3_side_solo" }
        ]
      },
      E3_side_elysia: {
        episode: 3, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ì„ íƒì— ì±…ì„ì„. ê·¸ê²Œ ë³„ì˜ ê·œìœ¨ì…ë‹ˆë‹¤.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E3_end" }]
      },
      E3_side_luna: {
        episode: 3, image: "luna",
        text: "ë£¨ë‚˜: \"ê·¸ë˜, ë„¤ ë°¤ì€ ë„¤ ê²ƒì´ì•¼. ë‚œ ë„¤ ê³ì„ ì§€í‚¬ê²Œ.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E3_end" }]
      },
      E3_side_solo: {
        episode: 3, image: "nulbam",
        text: "ë‚˜ëŠ” ë‘˜ì˜ ì‹œì„ ì„ í”¼í•˜ê³ , ê²€ì€ ë³„ì„ ë– ì˜¬ë¦°ë‹¤. ë‹µì€, ë‚´ ì•ˆì— ìˆë‹¤.",
        choices: [{ text: "ë‹¤ìŒ", next: "E3_end" }]
      },
      E3_end: {
        episode: 3, image: "nulbam",
        text: "ã€3í™” ëã€‘\nì”í–¥ì€ ì ì  ë” ì„ ëª…í•´ì§„ë‹¤.",
        choices: [{ text: "â–¶ 4í™” ì‹œì‘", next: "E4_intro" }]
      },

      // --------- Episode 4: ê¸ˆì§€ëœ ë„ì„œê´€ ---------
      E4_intro: {
        episode: 4, image: "seraphia",
        text:
"ê¸ˆì§€ëœ ë„ì„œê´€. ë¨¼ì§€ ì†ì—ì„œ ë¹›ë‚˜ëŠ” ê¸°ë¡.\nã€ë³„ì„ ìƒì€ ìëŠ”, ì—¬ì‹ ì˜ ì„œê³ ì—ì„œ ìì‹ ì„ ì°¾ëŠ”ë‹¤.ã€",
        choices: [
          { text: "ê¸°ë¡ì„ ì½ëŠ”ë‹¤", next: "E4_record", setFlag: { library_read: true } },
          { text: "ì±…ì¥ì„ ë„˜ê¸°ë‹¤ ë´‰ì¸ì„ í‘¼ë‹¤", next: "E4_seal", setFlag: { seal_touched: true } }
        ]
      },
      E4_record: {
        episode: 4, image: "seraphia",
        text:
"ã€ê²€ì€ ë³„ì˜ ëˆˆë™ìëŠ” ì‹œë ¨ì„, í° ë³„ì˜ ìˆ¨ê²°ì€ ì„œì•½ì„ ë¶€ë¥¸ë‹¤.ã€\ní¬ë¯¸í•œ ì—¬ì‹ ì˜ ì´ë¦„: ì„¸ë¼í”¼ì•„.",
        choices: [{ text: "ë‹¤ìŒ", next: "E4_end" }]
      },
      E4_seal: {
        episode: 4, image: "seraphia",
        text:
"ì¹™â€” ì–µëˆŒë ¤ ìˆë˜ ë¹›ì´ ìƒˆì–´ ë‚˜ì™”ë‹¤.\nì†ì‚­ì„: ã€ë‚˜ë¥¼ ë¶€ë¥´ë ´â€¦ ë³„ì˜ ì—¬ì‹ , ì„¸ë¼í”¼ì•„.ã€",
        choices: [{ text: "ë‹¤ìŒ", next: "E4_end", setFlag: { seraphia_whisper: true } }]
      },
      E4_end: {
        episode: 4, image: "nulbam",
        text: "ã€4í™” ëã€‘\nì„¸ë¼í”¼ì•„ â€” ì´ë¦„ì´ ì…ì•ˆì—ì„œ êµ´ëŸ¬ê°„ë‹¤.",
        choices: [{ text: "â–¶ 5í™” ì‹œì‘", next: "E5_intro" }]
      },

      // --------- Episode 5: ë³„ì˜ ì¡°ê° (ì„¸ë¼í”¼ì•„) ---------
      E5_intro: {
        episode: 5, image: "seraphia",
        text:
"ë¹›ì´ ëª¨ì—¬ í˜•ìƒì„ ì´ë£¬ë‹¤. ì—¬ì‹  ì„¸ë¼í”¼ì•„ê°€ ëˆˆì„ ëœ¬ë‹¤.\nì„¸ë¼í”¼ì•„: ã€ê·¸ëŒ€, ë³„ì„ ìƒì—ˆêµ¬ë‚˜. ë¬»ê² ë‹¤ â€” ë¹›ì„ ë˜ì°¾ì„ ëœ»ì´ ìˆëŠ”ê°€?ã€",
        choices: [
          { text: "ì˜ˆ. ì œ ë³„ì„ ë˜ì°¾ê² ìŠµë‹ˆë‹¤.", next: "E5_oath", setFlag: { will_reclaim: true }, affection: { seraphia: 1 } },
          { text: "ì•„ì§ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤.", next: "E5_doubt" }
        ]
      },
      E5_oath: {
        episode: 5, image: "seraphia",
        text:
"ì„¸ë¼í”¼ì•„: ã€ì„œì•½ì—ëŠ” ëŒ€ê°€ê°€ ë”°ë¥¸ë‹¤. ê·¸ëŒ€ ê³ì˜ ëˆ„êµ°ê°€ì˜ ë°¤ì„ ì´í•´í•´ì•¼ í•œë‹¤.ã€",
        choices: [{ text: "ì„œì•½ì„ ë“£ê³  ê³ ê°œë¥¼ ë„ë•ì¸ë‹¤", next: "E5_end", setFlag: { oath_hint: true } }]
      },
      E5_doubt: {
        episode: 5, image: "seraphia",
        text:
"ì„¸ë¼í”¼ì•„: ã€ë¨¸ë¬´ë¥´ì§€ ë§ˆë¼. ë°¤ì€ íë¥¸ë‹¤.ã€\nê·¸ëŸ¬ë‚˜ ê·¸ë…€ì˜ ëˆˆë¹›ì€ ë‹¤ì •í–ˆë‹¤.",
        choices: [{ text: "ë‹¤ìŒ", next: "E5_end" }]
      },
      E5_end: {
        episode: 5, image: "nulbam",
        text: "ã€5í™” ëã€‘\nì„œì•½. ê·¸ë¦¬ê³  ëŒ€ê°€.",
        choices: [{ text: "â–¶ 6í™” ì‹œì‘", next: "E6_intro" }]
      },

      // --------- Episode 6: ê· ì—´ (ë£¨íŠ¸ ì„ íƒ) ---------
      E6_intro: {
        episode: 6, image: "nulbam",
        text:
"ê°ˆë¼ì§€ëŠ” ê¸¸. ì—˜ë¦¬ì‹œì•„ëŠ” ê·œìœ¨ì„, ë£¨ë‚˜ëŠ” ê³µê°ì„ ë§í•œë‹¤.\nëˆ„êµ¬ì™€ ë°¤ì„ ê±´ë„ ê²ƒì¸ê°€?",
        choices: [
          { text: "ì—˜ë¦¬ì‹œì•„ì™€ í•¨ê»˜í•œë‹¤", next: "E6_choose_elysia", setRoute: "elysia", affection: { elysia: 1 } },
          { text: "ë£¨ë‚˜ì™€ í•¨ê»˜í•œë‹¤", next: "E6_choose_luna", setRoute: "luna", affection: { luna: 1 } },
          { text: "í˜¼ì ê°€ê² ë‹¤", next: "E6_choose_solo", setRoute: "solo" }
        ]
      },
      E6_choose_elysia: {
        episode: 6, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ì¢‹ì•„ìš”. ë¹›ì€ í•¨ê»˜ì¼ ë•Œ ë” ë‹¨ë‹¨í•´ì ¸ìš”.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E6_end" }]
      },
      E6_choose_luna: {
        episode: 6, image: "luna",
        text: "ë£¨ë‚˜: \"ê´œì°®ì•„. ë„¤ ë°¤ì„ ì§€í‚¬ê²Œ. ìš°ë¦¬ê°€ í•¨ê»˜ë¼ë©´.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E6_end" }]
      },
      E6_choose_solo: {
        episode: 6, image: "nulbam",
        text: "ë‚˜ëŠ” í™€ë¡œ ì„ ë‹¤. ë°¤ì€ ì°¨ê°‘ì§€ë§Œ, ë³„ì€ í™€ë¡œ ë– ì˜¤ë¥´ê¸°ë„ í•œë‹¤.",
        choices: [{ text: "ë‹¤ìŒ", next: "E6_end" }]
      },
      E6_end: {
        episode: 6, image: "nulbam",
        text: "ã€6í™” ëã€‘\nì„ íƒì€ ì´ë£¨ì–´ì¡Œë‹¤.",
        choices: [{ text: "â–¶ 7í™” ì‹œì‘", next: "E7_intro" }]
      },

      // --------- Episode 7: ë£¨íŠ¸ ë¶„ê¸° ì‹œì‘ ---------
      E7_intro: {
        episode: 7,
        image: null,
        text: "ë‹¹ì‹ ì˜ ì„ íƒì— ë”°ë¼ ë‹¤ë¥¸ ë°¤ì´ ì—´ë¦°ë‹¤.",
        choices: [
          { text: "ê³„ì†â€¦", next: "E7_branch" }
        ]
      },
      E7_branch: {
        episode: 7,
        image: null,
        text: "â€¦",
        choices: [] // runtimeì—ì„œ routeì— ë”°ë¼ ë®ì–´ì“°ê¸°
      },

      // ----- Luna Route 7~8 -----
      L7_contract: {
        episode: 7, image: "luna",
        text:
"ë£¨ë‚˜: \"ë³„ì„ ë˜ì°¾ëŠ” ë°©ë²•ì´ ìˆì–´. í•˜ì§€ë§Œâ€¦ ë„¤ ì¼ë¶€ë¥¼ ë‚˜ëˆ ì¤˜ì•¼ í•´.\"\nê·¸ë…€ì˜ ëˆˆë™ìì—” ìŠ¬í””ê³¼ ê²°ì˜ê°€ í•¨ê»˜ ë¹„ì¹œë‹¤.",
        choices: [
          { text: "ë‚´ ì¼ë¶€ë¥¼ ë‚´ì–´ì¤€ë‹¤ (ì‹ ë¢°)", next: "L7_trust", affection: { luna: 2 }, setFlag: { luna_trust: true } },
          { text: "ê·¸ëŸ´ ìˆœ ì—†ì–´ (ê±°ë¶€)", next: "L7_refuse", affection: { luna: -1 } }
        ]
      },
      L7_trust: {
        episode: 7, image: "luna",
        text: "ë£¨ë‚˜: \"â€¦ê³ ë§ˆì›Œ. ê·¸ ë¯¿ìŒ, ë‚´ê°€ ì§€ì¼œì¤„ê²Œ.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "L8_dark_path" }]
      },
      L7_refuse: {
        episode: 7, image: "luna",
        text: "ë£¨ë‚˜: \"ë¯¸ì•ˆí•´. ì–µì§€ë¡œëŠ” ì•„ë¬´ê²ƒë„ ë˜ì°¾ì„ ìˆ˜ ì—†ì–´.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "L8_dark_path" }]
      },
      L8_dark_path: {
        episode: 8, image: "luna",
        text:
"ë°¤ì˜ ê¸¸ì„ ê±·ëŠ”ë‹¤. ê²€ì€ ë³„ì´ í˜¸í¡í•œë‹¤.\në£¨ë‚˜: \"ë‘ë ¤ì›Œë„ ê´œì°®ì•„. ë„ˆëŠ” ë„ˆë‹ˆê¹Œ.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E8_end" }]
      },

      // ----- Elysia Route 7~8 -----
      ELY7_trial: {
        episode: 7, image: "elysia",
        text:
"ì—˜ë¦¬ì‹œì•„: \"ê·œìœ¨ì˜ ì‹œí—˜ì„ í†µê³¼í•´ì•¼ í•´ìš”. ì§„ì‹¤ê³¼ ì±…ì„ â€” ë‘ ê°€ì§€ ëª¨ë‘.\"",
        choices: [
          { text: "ì§„ì‹¤ì„ íƒí•œë‹¤", next: "ELY7_truth", affection: { elysia: 2 }, setFlag: { elysia_truth: true } },
          { text: "ì±…ì„ì„ íƒí•œë‹¤", next: "ELY7_duty", affection: { elysia: 1 }, setFlag: { elysia_duty: true } }
        ]
      },
      ELY7_truth: {
        episode: 7, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ê±°ì§“ ì—†ëŠ” ë¹›ì€ ë©€ë¦¬ ë¹„ì¶”ì£ .\"",
        choices: [{ text: "ë‹¤ìŒ", next: "ELY8_ritual" }]
      },
      ELY7_duty: {
        episode: 7, image: "elysia",
        text: "ì—˜ë¦¬ì‹œì•„: \"ì±…ì„ì€ ë¬´ê²ì§€ë§Œ, ê·¸ë˜ì„œ ì¡´ì¤‘ë°›ì•„ìš”.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "ELY8_ritual" }]
      },
      ELY8_ritual: {
        episode: 8, image: "rite_of_light.mp4",
        text:
"ë¹›ì˜ ì˜ì‹ì´ ì‹œì‘ëœë‹¤. ë§¥ë°•ì²˜ëŸ¼ ê³ ë¥¸ í˜¸í¡.\nì—˜ë¦¬ì‹œì•„: \"ë‹¹ì‹ ì˜ ë³„, í•¨ê»˜ ë˜ì°¾ì•„ìš”.\"",
        choices: [{ text: "ë‹¤ìŒ", next: "E8_end" }]
      },

      // ----- Solo Route 7~8 -----
      S7_solo: {
        episode: 7, image: "nulbam",
        text:
"í™€ë¡œ ê±·ëŠ” ë°¤. ê·¸ëŸ¬ë‚˜ ë°œê±¸ìŒì€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤.\në‚˜ëŠ” ë‚˜ì˜ ë°©ì‹ìœ¼ë¡œ ë‹µì„ ì°¾ê² ë‹¤.",
        choices: [{ text: "ë‹¤ìŒ", next: "S8_echo" }]
      },
      S8_echo: {
        episode: 8, image: "nulbam",
        text:
"ê²€ì€ ë³„ì˜ ë©”ì•„ë¦¬ê°€ ê°€ìŠ´ì„ ìš¸ë¦°ë‹¤. ê·¸ ì†ì—ëŠ” ë‚´ ëª©ì†Œë¦¬ê°€ ìˆì—ˆë‹¤.\nâ€˜ë„ ë¯¿ì–´.â€™",
        choices: [{ text: "ë‹¤ìŒ", next: "E8_end" }]
      },

      // --------- Episode 8 End / Episode 9 Begin ---------
      E8_end: {
        episode: 8, image: "nulbam",
        text: "ã€8í™” ëã€‘\nì‹œë ¨ì˜ ë°¤ì´ ëë‚˜ê³ , ì„ íƒì€ ëª¨ì˜€ë‹¤.",
        choices: [{ text: "â–¶ 9í™” ì‹œì‘", next: "E9_intro" }]
      },

      // --------- Episode 9: ì„ íƒì˜ ë°¤ (í•©ë¥˜) ---------
      E9_intro: {
        episode: 9, image: "seraphia",
        text:
"ì„¸ë¼í”¼ì•„: ã€ë§ˆì§€ë§‰ ë°¤. ë„ˆì˜ ë³„ì€ ë„ˆ í˜¼ìë§Œì˜ ê²ƒì´ ì•„ë‹ˆë‹¤. ê·¸ ë¹›ì´ ë‹¿ì„ ì‚¬ëŒì„ ìƒê°í•˜ë¼.ã€",
        choices: [
          { text: "ë‚˜ì˜ ë¹›ì„ ë‚˜ëˆ„ê² ë‹¤ (ì´íƒ€)", next: "E9_share", setFlag: { altruism: true } },
          { text: "ë¨¼ì € ë‚˜ë¥¼ ì™„ì„±í•˜ê² ë‹¤ (ìê¸°íšŒë³µ)", next: "E9_self", setFlag: { self_first: true } }
        ]
      },
      E9_share: {
        episode: 9, image: "seraphia",
        text: "ì„¸ë¼í”¼ì•„: ã€ê·¸ ì„ íƒ, ê²°ì½” ê°€ë³ì§€ ì•Šë‹¤. ê·¸ëŸ¬ë‚˜ ë¹›ì€ ë¶„ê¸°(åˆ†å²)ì—ì„œ ê°•í•´ì§„ë‹¤.ã€",
        choices: [{ text: "ë‹¤ìŒ", next: "E9_gate" }]
      },
      E9_self: {
        episode: 9, image: "seraphia",
        text: "ì„¸ë¼í”¼ì•„: ã€ë„ˆì˜ ìƒì²˜ë¥¼ ë¨¼ì € ê°ì‹¸ëŠ” ê²ƒ ë˜í•œ ìš©ê¸°ë‹¤.ã€",
        choices: [{ text: "ë‹¤ìŒ", next: "E9_gate" }]
      },
      E9_gate: {
        episode: 9, image: "seraphia",
        text:
"ë¬¸ ì•ì— ì„ ë‹¤. ë¬¸ì€ ë‹¹ì‹ ì˜ ì„ íƒê³¼ í˜¸ê°, ì„œì•½ì„ ëª¨ë‘ ê¸°ì–µí•œë‹¤.",
        choices: [{ text: "ë¬¸ì„ ì—°ë‹¤", next: "E10_check" }]
      },

      // --------- Episode 10: ë³„ë¹› ì•„ë˜ì˜ ì„œì•½ (ì—”ë”© ì²´í¬) ---------
      E10_check: {
        episode: 10, image: "seraphia",
        text: "ë³„ë¹›ì´ ëª°ë ¤ë“ ë‹¤. â€” ì´ì œ, ê²°ë§ì„ ë§ì„ ì‹œê°„.",
        choices: [{ text: "ê²°ë§ì„ ë§ëŠ”ë‹¤", next: "ENDING_COMPUTE" }]
      },

      // --------- Endings (ë Œë” í›„ ê³ ì •) ---------
      END_TRUE: {
        episode: 10, image: "seraphia",
        text:
"ã€ì§„ì—”ë”©ã€‘ ë³„ë¹› ì•„ë˜ì˜ ì„œì•½\n\në„ˆì™€ ê·¸ë“¤ì´ ë‚˜ëˆˆ ì‹ ë¢°ì™€ ì±…ì„, ì´í•´ì™€ ìš©ê¸°.\nì„¸ë¼í”¼ì•„: ã€ë„ˆì˜ ë°¤ì€ ì´ì œ ë³„ì´ ë˜ì—ˆë‹¤. í•¨ê»˜ ë¹„ì¶°ë¼.ã€",
        choices: [
          { text: "ì²˜ìŒìœ¼ë¡œ", next: "E1_intro" }
        ]
      },
      END_ELYSIA: {
        episode: 10, image: "elysia",
        text:
"ã€ì—˜ë¦¬ì‹œì•„ ì—”ë”©ã€‘ ë¹›ì˜ ì˜ì‹\n\nì—˜ë¦¬ì‹œì•„: \"ë‹¹ì‹ ì˜ ë³„ì€ ë‹¨ë‹¨í•´ì¡Œì–´ìš”. í•¨ê»˜ë¼ë©´, ë” ë©€ë¦¬.\"",
        choices: [{ text: "ì²˜ìŒìœ¼ë¡œ", next: "E1_intro" }]
      },
      END_LUNA: {
        episode: 10, image: "luna",
        text:
"ã€ë£¨ë‚˜ ì—”ë”©ã€‘ ë°¤ì˜ ì•ˆìª½\n\në£¨ë‚˜: \"ë‘ë ¤ì›Œë„ ê´œì°®ì•„. ë„Œ ë„¤ ë³„ì„ ë˜ì°¾ì•˜ì–´. ë‚œ, ë„¤ ì˜†ì—.\"",
        choices: [{ text: "ì²˜ìŒìœ¼ë¡œ", next: "E1_intro" }]
      },
      END_SOLO: {
        episode: 10, image: "nulbam",
        text:
"ã€ì†”ë¡œ ì—”ë”©ã€‘ ë‚˜ì˜ ë³„\n\ní™€ë¡œ ê±·ëŠ” ë°¤ ëì—ì„œ, ë„ˆëŠ” ë„¤ ëª©ì†Œë¦¬ë¥¼ ë“¤ì—ˆë‹¤.\nê·¸ ëª©ì†Œë¦¬ëŠ” ì¡°ìš©í–ˆê³ , ê·¸ë˜ì„œ ê°•í–ˆë‹¤.",
        choices: [{ text: "ì²˜ìŒìœ¼ë¡œ", next: "E1_intro" }]
      },
      END_BAD: {
        episode: 10, image: "nulbam",
        text:
"ã€ë°°ë“œ ì—”ë”©ã€‘ êº¼ì§„ ë³„\n\nì„ íƒì€ í©ì–´ì¡Œê³ , ë¹›ì€ ë‹¿ì§€ ëª»í–ˆë‹¤.\nê·¸ëŸ¬ë‚˜ ê¸°ì–µí•˜ë¼ â€” ë°¤ì€ ì–¸ì œë‚˜ ë‹¤ì‹œ ì˜¨ë‹¤.",
        choices: [{ text: "ì²˜ìŒìœ¼ë¡œ", next: "E1_intro" }]
      }
    };

    // ë£¨íŠ¸ ë¶„ê¸° ì¥ë©´ì„ ëŸ°íƒ€ì„ì— ì£¼ì…
    function ensureBranchScenes() {
      if (state.route === "luna") {
        scenes.E7_branch.image = "luna";
        scenes.E7_branch.text = "ë£¨ë‚˜ì˜ ë°¤ì´ ë„ˆë¥¼ ë¶€ë¥¸ë‹¤.";
        scenes.E7_branch.choices = [{ text: "ë£¨ë‚˜ì˜ ì œì•ˆì„ ë“£ëŠ”ë‹¤", next: "L7_contract" }];
      } else if (state.route === "elysia") {
        scenes.E7_branch.image = "elysia";
        scenes.E7_branch.text = "ì—˜ë¦¬ì‹œì•„ì˜ ë¹›ì´ ë„ˆë¥¼ ì´ëˆë‹¤.";
        scenes.E7_branch.choices = [{ text: "ì—˜ë¦¬ì‹œì•„ì˜ ì‹œí—˜ì„ ë”°ë¥¸ë‹¤", next: "ELY7_trial" }];
      } else { // solo
        scenes.E7_branch.image = "nulbam";
        scenes.E7_branch.text = "ë„ˆëŠ” í™€ë¡œ ì„ ë‹¤. ê·¸ëŸ¬ë‚˜ ë³„ì€ í™€ë¡œ ë– ì˜¤ë¥´ê¸°ë„ í•œë‹¤.";
        scenes.E7_branch.choices = [{ text: "í˜¼ì ê¸¸ì„ ì—°ë‹¤", next: "S7_solo" }];
      }
    }

    // ì—”ë”© ê³„ì‚°
    function computeEndingKey() {
      const E = state.affection.elysia;
      const L = state.affection.luna;
      const S = state.affection.seraphia;
      const f = state.flags;

      const hasLibrary = !!(f.library_read || f.seraphia_whisper);
      const oathAware = !!f.oath_hint;
      const altru = !!f.altruism;
      const selfFirst = !!f.self_first;

      // ì§„ì—”ë”© ì¡°ê±´: ë£¨íŠ¸ ìœ íš¨ + í•´ë‹¹ ì¸ë¬¼ í˜¸ê° ì¶©ë¶„ + ë„ì„œê´€ ë‹¨ì„œ + ì„œì•½ ì¸ì§€ + ì´íƒ€ í˜¹ì€ ì±…ì„ ì„ íƒì´ ì¡°í•©
      const routeGood =
        (state.route === "elysia" && (E >= 4) && (f.elysia_truth || f.elysia_duty)) ||
        (state.route === "luna" && (L >= 4) && (f.luna_trust));

      if (routeGood && hasLibrary && oathAware && (altru || f.elysia_duty)) {
        return "END_TRUE";
      }

      // ìºë¦­í„° ì—”ë”©
      if (state.route === "elysia" && E >= 3) return "END_ELYSIA";
      if (state.route === "luna" && L >= 3) return "END_LUNA";
      if (state.route === "solo" && selfFirst) return "END_SOLO";

      // ì‹¤íŒ¨ / ë¶ˆì¶©ë¶„
      return "END_BAD";
    }

    function showScene(name) {
      const scene = scenes[name];
      if (!scene) return;

      // ìœ ì§€
      state.scene = name;
      if (scene.episode) {
        state.episode = scene.episode;
        setEpisode(scene.episode);
      }

      // ì´ë¯¸ì§€
      setImage(scene.image);

      // í…ìŠ¤íŠ¸ ì¶œë ¥ (íƒ€ì íš¨ê³¼)
      typeText(scene.text);

      // ì„ íƒì§€ ëœë”
      choicesBox.innerHTML = "";
      scene.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.textContent = choice.text;
        btn.classList.add("choice-btn");
        btn.onclick = () => {
          // ì• ì •ë„/í”Œë˜ê·¸/ë£¨íŠ¸ ì²˜ë¦¬
          applyAffection(choice.affection);
          applyFlags(choice.setFlag, choice.unsetFlag);
          if (choice.setRoute) state.route = choice.setRoute;

          // íŠ¹ìˆ˜ ëª©ì ì§€
          if (choice.next === "ENDING_COMPUTE") {
            const key = computeEndingKey();
            showScene(key);
            updateStatus();
            return;
          }

          // ë£¨íŠ¸ ë¶„ê¸° ë³´ì •
          if (choice.next === "E7_branch") {
            ensureBranchScenes();
          }

          showScene(choice.next);
          updateStatus();
        };
        choicesBox.appendChild(btn);
      });

      updateStatus();
    }

    // ì´ˆê¸° ì‹œì‘
    showScene(state.scene);
  </script>
</body>
</html>
